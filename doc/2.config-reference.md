# smOTA 配置宏定义说明

> **文档版本**：v1.0
> **编写日期**：2026-01-26

---

## 目录

1. [配置方式](#1-配置方式)
2. [升级模式配置](#2-升级模式配置)
3. [可靠性配置](#3-可靠性配置)
4. [Flash 布局配置](#4-flash-布局配置)
5. [固件包配置](#5-固件包配置)
6. [缓冲区配置](#6-缓冲区配置)
7. [加密算法配置](#7-加密算法配置)
8. [调试配置](#8-调试配置)
9. [超时配置](#9-超时配置)
10. [辅助宏定义](#10-辅助宏定义)

---

## 1. 配置方式

### 1.1 方式一：创建自定义配置文件

创建一个头文件（如 `my_smota_config.h`），在其中定义需要覆盖的宏：

```c
// my_smota_config.h
#define SMOTA_MODE 1
#define SMOTA_RELIABILITY_SOURCE 1
#define SMOTA_APP_SIZE 0x20000
```

然后在编译选项中添加：
```
-DSMOTA_USER_CONFIG_FILE="my_smota_config.h"
```

### 1.2 方式二：编译选项直接定义

直接在编译选项中定义：
```
-DSMOTA_MODE=1 -DSMOTA_RELIABILITY_SOURCE=1
```

### 1.3 配置优先级

```
编译选项 > 用户配置文件 > 默认值
```

---

## 2. 升级模式配置

### SMOTA_MODE

| 值 | 模式 | 适用场景 | 特点 |
|:--|:-----|:---------|:-----|
| `0` | 双 Bank 硬件交换 | STM32G0/L4 等支持硬件 Bank 交换的 MCU | 硬件直接对调地址映射，无需物理搬运，升级速度最快 |
| `1` | 双槽位软件搬运 | Flash 较大但不支持硬件交换的 MCU | App 存在 Active 区，备份存在 Secondary 区，由 Bootloader 执行物理拷贝 |
| `2` | 单分区覆盖 | Flash 空间紧缺的 MCU | App 触发重启，Bootloader 接管通讯并直接覆盖写入 |

**默认值**：`2`

### 三种模式的 Flash 布局

#### 模式 0：双 Bank 硬件交换

```
Flash 地址空间
┌─────────────────────────────────────────────────────────┐
│ SMOTA_FLASH_BASE_ADDR                                   │
│ 0x08000000  ┌──────────────────────────┐               │
│             │      Bootloader          │ SMOTA_BOOTLOADER_SIZE
│             ├──────────────────────────┤               │
│             │                          │               │
│ SMOTA_APP_ADDR                                     │
│ 0x08004000  │   Bank 1 (Active App)    │ SMOTA_APP_SIZE
│             │   (硬件映射运行)          │               │
│             │                          │               │
│             └──────────────────────────┘               │
│
│ SMOTA_BACKUP_ADDR                                  │
│ 0x08040000  │   Bank 2 (Backup)          │ ← 新固件写这里
│             │                          │               │
│             └──────────────────────────┘               │
└─────────────────────────────────────────────────────────┘

SMOTA_APP_OFFSET    = 0
SMOTA_BACKUP_OFFSET = SMOTA_BOOTLOADER_SIZE
```

#### 模式 1：双槽位软件搬运

```
Flash 地址空间
┌─────────────────────────────────────────────────────────┐
│ SMOTA_FLASH_BASE_ADDR                                   │
│ 0x08000000  ┌──────────────────────────┐               │
│             │      Bootloader          │ SMOTA_BOOTLOADER_SIZE
│             ├──────────────────────────┤               │
│ SMOTA_APP_ADDR                                     │
│ 0x08004000  │   Slot 0 (Active)        │ SMOTA_APP_SIZE
│             │   (当前运行)              │               │
│             │                          │               │
│             ├──────────────────────────┤               │
│ SMOTA_BACKUP_ADDR                                  │
│ 0x08044000  │   Slot 1 (Backup)          │ ← 新固件写这里
│             │   (待激活)                │ SMOTA_APP_SIZE
│             │                          │               │
│             └──────────────────────────┘               │
└─────────────────────────────────────────────────────────┘

SMOTA_APP_OFFSET    = SMOTA_BOOTLOADER_SIZE
SMOTA_BACKUP_OFFSET = SMOTA_BOOTLOADER_SIZE + SMOTA_APP_SIZE
```

#### 模式 2：单分区覆盖

```
Flash 地址空间
┌─────────────────────────────────────────────────────────┐
│ SMOTA_FLASH_BASE_ADDR                                   │
│ 0x08000000  ┌──────────────────────────┐               │
│             │      Bootloader          │ SMOTA_BOOTLOADER_SIZE
│             ├──────────────────────────┤               │
│ SMOTA_APP_ADDR                                     │
│ 0x08004000  │   App                     │ SMOTA_APP_SIZE
│             │   (运行时也是这里)        │ ← 新固件直接覆盖这里
│             │                          │               │
│             │                          │               │
│             └──────────────────────────┘               │
└─────────────────────────────────────────────────────────┘

SMOTA_APP_OFFSET    = SMOTA_BOOTLOADER_SIZE
SMOTA_BACKUP_OFFSET = 0 (无备份区)
```

---

## 3. 可靠性配置

### 必须开启的可靠性（默认开启）

| 可靠性类型 | 技术 | 说明 |
|:----------|:-----|:-----|
| **运行可靠性** | 断电保护、固件回滚 | 确保升级过程在异常情况下系统能够恢复或回滚 |
| **内容可靠性** | SHA-256 哈希校验 | 确保固件在传输与存储过程中未发生逻辑错误 |

### SMOTA_RELIABILITY_SOURCE

**来源可靠性** - 确保固件由唯一合法的私钥持有者签发

- **技术**：ECDSA-P256 (secp256r1) 签名验证
- **默认值**：`0`（关闭）
- **开启条件**：需要防止固件被伪造时开启

```c
#define SMOTA_RELIABILITY_SOURCE 1  // 开启
```

### SMOTA_RELIABILITY_TRANSMISSION

**过程可靠性** - 防止固件被黑客通过总线监听进行逆向工程

- **技术**：AES-128-CTR 对称加密 + HMAC-SHA256 密钥派生
- **默认值**：`0`（关闭）
- **开启条件**：需要防止固件在传输过程中被窃取时开启

```c
#define SMOTA_RELIABILITY_TRANSMISSION 1  // 开启
```

### SMOTA_RELIABILITY_VERSION

**版本可靠性** - 防止黑客通过重放（Replay）带有已知漏洞的旧版合法固件攻击系统

- **技术**：防回滚机制（Anti-Rollback）
- **默认值**：`0`（关闭）
- **开启条件**：需要防止固件版本回退时开启

```c
#define SMOTA_RELIABILITY_VERSION 1  // 开启
```

---

## 4. Flash 布局配置

### SMOTA_FLASH_BASE_ADDR

Flash 基地址

| MCU | 值 |
|:-----|:-----|
| STM32 | `0x08000000` |
| 某些 RISC-V | `0x00000000` |

**默认值**：`0x08000000`

### SMOTA_BOOTLOADER_SIZE

Bootloader 占用空间

- **单位**：字节
- **建议范围**：8-16KB
- **默认值**：`0x4000` (16KB)

```c
#define SMOTA_BOOTLOADER_SIZE 0x4000  // 16KB
```

### SMOTA_APP_SIZE

应用程序区大小

- **单位**：字节
- **默认值**：`0x40000` (256KB)
- **设置建议**：根据实际 App 大小 + 预留空间

```c
#define SMOTA_APP_SIZE 0x20000  // 128KB
```

### SMOTA_FLASH_PAGE_SIZE

Flash 页大小（用于擦除操作）

| MCU | 页/扇区大小 |
|:-----|:------------|
| STM32F1 | 1KB (小页) / 2KB (大页) |
| STM32F4 | 16KB / 64KB / 128KB (扇区) |
| STM32L4 | 2KB |

**默认值**：`0x800` (2KB)

### SMOTA_FLASH_SIZE

Flash 总容量（必须根据实际 MCU 型号设置）

- **单位**：字节
- **默认值**：`0x80000` (512KB)
- **设置建议**：必须与实际 MCU Flash 容量一致

| 常见容量 | 值 |
|:--------|:-----|
| 64KB | `0x10000` |
| 128KB | `0x20000` |
| 256KB | `0x40000` |
| 512KB | `0x80000` |
| 1024KB | `0x100000` |

```c
#define SMOTA_FLASH_SIZE 0x20000  // 128KB
```

**编译时校验**：系统会自动检查 App 区和备份区是否超出 Flash 容量，如果超出会报错。

---

## 5. 固件包配置

### SMOTA_PACKET_MAX_SIZE

最大数据包大小

- **单位**：字节
- **默认值**：`1024`
- **限制**：受可用 RAM 大小和传输协议 MTU 限制

```c
#define SMOTA_PACKET_MAX_SIZE 512  // RAM 受限时可用更小值
```

### SMOTA_HEADER_SIZE

固件包头部大小

- **单位**：字节
- **默认值**：`256`
- **说明**：固定大小，包含版本、大小、哈希、签名等信息

### SMOTA_MAGIC_WORD

固件包魔术字

- **默认值**：`0xAA55AA55`
- **作用**：用于识别合法的 smOTA 固件包

---

## 6. 缓冲区配置

### SMOTA_WORK_BUF_SIZE

工作缓冲区大小

- **单位**：字节
- **最小值**：`512`
- **建议值**：`2048`
- **默认值**：`2048`
- **用途**：用于解密、Hash 计算等操作

```c
#define SMOTA_WORK_BUF_SIZE 2048
```

### SMOTA_DECRYPT_BUF_SIZE

解密缓冲区大小

- **单位**：字节
- **默认值**：`1024`
- **限制**：不能超过 `SMOTA_WORK_BUF_SIZE`
- **用途**：用于流式解密

```c
#define SMOTA_DECRYPT_BUF_SIZE 1024
```

---

## 7. 加密算法配置

### SMOTA_USE_TINYCRYPT

使用 TinyCrypt 库

- **默认值**：`1`
- **设为 0**：需要自行实现加密算法接口

```c
#define SMOTA_USE_TINYCRYPT 1
```

### AES 加密模式

AES 加密模式**固定为 CTR**（唯一支持流式处理的模式），无需配置。

### SMOTA_KDF_CONTEXT

密钥派生上下文字符串

- **默认值**：`"smOTA_Enc_v1"`
- **作用**：用于 HMAC-SHA256 密钥派生

**密钥派生原理**：

```
派生密钥 = HMAC-SHA256(主密钥, 上下文字符串)
```

上下文字符串的作用是**绑定密钥用途**——同一个主密钥配合不同的上下文，会派生出完全不同的密钥。

```c
// 示例
加密密钥 = HMAC-SHA256(主密钥, "smOTA_Enc_v1")  → 得到密钥A
认证密钥 = HMAC-SHA256(主密钥, "smOTA_Auth_v1") → 得到密钥B
```

---

## 8. 调试配置

### SMOTA_ENABLE_DEBUG

启用调试输出

- **默认值**：`0`（关闭）
- **说明**：开启后会输出详细的调试信息，增加代码体积

```c
#define SMOTA_ENABLE_DEBUG 1  // 开启调试
```

### SMOTA_DEBUG_PRINTF

调试输出函数（仅在 `SMOTA_ENABLE_DEBUG=1` 时有效）

- **默认实现**：`printf("[smOTA] " __VA_ARGS__)`
- **自定义**：用户可重定义为自己的输出函数（如 UART 输出）

```c
// 自定义 UART 调试输出
#define SMOTA_DEBUG_PRINTF(...) UART_Printf("[OTA] " __VA_ARGS__)
```

---

## 9. 超时配置

### SMOTA_PACKET_TIMEOUT_MS

数据包接收超时时间

- **单位**：毫秒
- **默认值**：`5000` (5秒)

```c
#define SMOTA_PACKET_TIMEOUT_MS 10000  // 10秒
```

### SMOTA_VERIFY_TIMEOUT_MS

固件验签超时时间

- **单位**：毫秒
- **默认值**：`30000` (30秒)

```c
#define SMOTA_VERIFY_TIMEOUT_MS 60000  // 60秒
```

---

## 10. 辅助宏定义

以下宏由配置自动计算得出：

### 地址计算宏

```c
// App 区域起始地址
SMOTA_APP_ADDR = SMOTA_FLASH_BASE_ADDR + SMOTA_APP_OFFSET

// 备份区域起始地址
SMOTA_BACKUP_ADDR = SMOTA_FLASH_BASE_ADDR + SMOTA_BACKUP_OFFSET
```

### 对齐宏

```c
// 向上对齐
SMOTA_ALIGN_UP(size, align)   = (((size) + ((align) - 1)) & ~((align) - 1))

// 向下对齐
SMOTA_ALIGN_DOWN(size, align) = ((size) & ~((align) - 1))
```

**使用示例**：

```c
// 计算对齐到页边界的大小
uint32_t erase_size = SMOTA_ALIGN_UP(firmware_size, SMOTA_FLASH_PAGE_SIZE);
```

---

## 配置示例

### 示例 1：最小配置（Flash 受限）

```c
// my_config.h
#define SMOTA_MODE 2                           // 单分区模式
#define SMOTA_APP_SIZE 0x10000                 // 64KB
#define SMOTA_WORK_BUF_SIZE 512                // 最小缓冲区
#define SMOTA_PACKET_MAX_SIZE 256              // 小包传输
```

### 示例 2：安全增强配置

```c
// my_config.h
#define SMOTA_MODE 1                           // 双槽位模式（支持回滚）
#define SMOTA_RELIABILITY_SOURCE 1             // 启用签名验证
#define SMOTA_RELIABILITY_TRANSMISSION 1       // 启用加密传输
#define SMOTA_RELIABILITY_VERSION 1            // 启用防回滚
```

### 示例 3：STM32G0 双 Bank 配置

```c
// my_config.h
#define SMOTA_MODE 0                           // 双 Bank 模式
#define SMOTA_FLASH_BASE_ADDR 0x08000000       // STM32 基地址
#define SMOTA_BOOTLOADER_SIZE 0x2000           // 8KB
#define SMOTA_APP_SIZE 0x20000                 // 128KB
#define SMOTA_FLASH_PAGE_SIZE 0x800            // 2KB
```

---

**文档结束**
