# smOTA 项目结构规划说明

> **项目名称**：Universal Secure OTA Library (smOTA)
> **文档版本**：v1.1
> **编写日期**：2026-01-26

---

## 目录

1. [概述](#1-概述)
2. [目录结构设计](#2-目录结构设计)
3. [模块划分说明](#3-模块划分说明)
4. [文件组织规范](#4-文件组织规范)
5. [依赖管理](#5-依赖管理)
6. [开发工作流](#6-开发工作流)
7. [用户集成指南](#7-用户集成指南)

---

## 1. 概述

本项目是一套轻量级、高度可靠且安全的 MCU 固件升级库，支持多种架构（ARM Cortex-M、RISC-V 等）和三种升级模式（双 Bank 交换、双槽位搬运、单分区覆盖）。

### 1.1 设计原则

| 原则 | 说明 |
|:-----|:-----|
| **模块化** | 各功能模块职责单一，接口清晰 |
| **可移植性** | 通过 HAL 层隔离硬件差异 |
| **可配置性** | 通过编译选项控制功能裁剪 |
| **安全性** | 支持固件签名验证和加密传输 |
| **易用性** | 统一头文件，简化用户集成 |

---

## 2. 目录结构设计

```
SMOTA/
├── readme.md                  # 项目主文档（需求规格说明）
├── LICENSE                    # 许可证
│
├── doc/                       # 项目文档目录
│   ├── project-structure.md   # 本文档：项目结构规划
│   ├── api-reference.md       # API 接口参考手册
│   ├── porting-guide.md       # 移植指南
│   └── security-guide.md      # 安全方案说明
│
├── smota_tools/               # 工具集
│   ├── develop.md             # 开发说明
│   ├── packager/              # 固件打包工具
│   │   ├── packager.py
│   │   └── requirements.txt
│   └── signer/                # 签名工具
│       ├── keygen.py
│       └── sign.py
│
├── smota/                     # 代码父文件夹（用户复制此目录）
│   ├── smota.h                # 统一头文件
│   │
│   ├── smota_core/            # 核心库（平台无关）
│   │   ├── inc/
│   │   │   ├── smota_config.h     # 配置文件
│   │   │   ├── smota_types.h      # 类型定义
│   │   │   ├── smota_state.h      # 状态机
│   │   │   ├── smota_packet.h     # 包解析
│   │   │   ├── smota_verify.h     # 验签模块
│   │   │   └── smota_hal.h        # HAL 接口定义
│   │   └── src/
│   │       ├── smota_core.c       # 核心功能
│   │       ├── smota_state.c      # 状态机实现
│   │       ├── smota_packet.c     # 包解析实现
│   │       └── smota_verify.c     # 验签实现
│   │
│   ├── smota_hal/             # 硬件抽象层（平台相关）
│   │   ├── inc/
│   │   │   └── smota_hal_impl.h   # HAL 实现接口
│   │   └── ports/               # 各平台移植目录
│   │       ├── stm32/           # STM32 系列
│   │       │   ├── smota_hal_stm32.c
│   │       │   └── smota_flash_stm32.c
│   │       ├── gd32/            # GD32 系列
│   │       │   ├── smota_hal_gd32.c
│   │       │   └── smota_flash_gd32.c
│   │       └── riscv/           # RISC-V 系列
│   │           ├── smota_hal_riscv.c
│   │           └── smota_flash_riscv.c
│   │
│   ├── smota_crypto/          # 加密模块
│   │   ├── inc/
│   │   │   └── smota_crypto.h
│   │   └── src/
│   │       ├── smota_sha256.c   # SHA-256 实现
│   │       ├── smota_ecdsa.c    # ECDSA-P256 验签
│   │       ├── smota_aes.c      # AES-128 加解密
│   │       └── smota_kdf.c      # 密钥派生
│   │
│   ├── smota_bootloader/      # Bootloader 实现
│   │   ├── inc/
│   │   │   └── bootloader.h
│   │   └── src/
│   │       ├── bootloader_main.c
│   │       ├── bootloader_dualbank.c
│   │       ├── bootloader_dualslot.c
│   │       └── bootloader_singleslot.c
│   │
│   └── third_party/           # 第三方库
│       └── tinycrypt/         # TinyCrypt 加密库
│           ├── inc/
│           └── src/
│
├── examples/                  # 示例代码
│   ├── stm32_hal_example/     # STM32 HAL 示例
│   └── baremetal_example/     # 裸机示例
│
├── tests/                     # 测试代码
│   ├── unit/                  # 单元测试
│   └── integration/           # 集成测试
│
├── scripts/                   # 构建脚本
│
└── Makefile                   # 主 Makefile
```

---

## 3. 模块划分说明

### 3.1 核心库 (smota_core)

**职责**：实现 OTA 升级的核心逻辑，与硬件平台无关。

| 文件 | 功能 |
|:-----|:-----|
| `smota_core.c` | 初始化、下载控制、状态管理 |
| `smota_state.c` | 状态机实现与转换 |
| `smota_packet.c` | 固件包解析与组装 |
| `smota_verify.c` | 签名验证、Hash 校验 |

### 3.2 硬件抽象层 (smota_hal)

**职责**：隔离硬件差异，为上层提供统一的操作接口。

| 接口类别 | 功能 |
|:---------|:-----|
| Flash 操作 | 读写擦除 |
| 系统控制 | 复位、看门狗 |
| 模式特定 | Bank 交换、槽位选择 |
| 加解密 | AES、SHA、ECDSA |

### 3.3 加密模块 (smota_crypto)

**职责**：实现密码学算法，确保固件来源可靠性和传输安全性。

| 组件 | 算法 | 用途 |
|:-----|:-----|:-----|
| SHA-256 | 哈希 | 内容完整性校验 |
| ECDSA-P256 | 数字签名 | 来源验证 |
| AES-128-CTR | 对称加密 | 固件加密传输 |
| HMAC-SHA256 | 密钥派生 | 一机一密 |

### 3.4 Bootloader (smota_bootloader)

**职责**：实现三种升级模式的启动逻辑。

| 模式 | 文件 | 特点 |
|:-----|:-----|:-----|
| 双 Bank | `bootloader_dualbank.c` | 硬件交换，极速回滚 |
| 双槽位 | `bootloader_dualslot.c` | 软件搬运，支持回滚 |
| 单分区 | `bootloader_singleslot.c` | 空间节省，无回滚 |

### 3.5 工具集 (smota_tools)

**职责**：提供固件打包、签名等开发辅助工具。

| 工具 | 功能 | 输入 | 输出 |
|:-----|:-----|:-----|:-----|
| 打包工具 | 生成固件包 | .bin + 版本信息 | .ota |
| 密钥生成 | 生成密钥对 | 无 | 私钥/公钥 |
| 签名工具 | 计算签名 | 固件 + 私钥 | 签名数据 |

---

## 4. 文件组织规范

### 4.1 命名规范

| 类型 | 规范 | 示例 |
|:-----|:-----|:-----|
| 头文件 | `smota_模块名.h` | `smota_hal.h` |
| 源文件 | `smota_模块名.c` | `smota_hal.c` |
| 类型定义 | `模块名_名称_t` | `OTA_State_t` |
| 函数 | `模块名_动作_对象` | `OTA_DownloadStart` |
| 宏定义 | `模块名_名称` | `OTA_MAX_PACKET_SIZE` |

### 4.2 头文件保护

```c
#ifndef SMOTA_XXX_H
#define SMOTA_XXX_H

// 内容

#endif // SMOTA_XXX_H
```

### 4.3 注释规范

```c
/**
 * @brief  函数简要说明
 * @param  param1 参数1说明
 * @param  param2 参数2说明
 * @return 返回值说明
 * @note   备注信息
 */
```

---

## 5. 依赖管理

### 5.1 第三方依赖

| 库名 | 版本 | 用途 | 许可证 |
|:-----|:-----|:-----|:-------|
| TinyCrypt | - | SHA-256、ECDSA、AES | Apache 2.0 |

### 5.2 可选依赖

| 组件 | 用途 | 替代方案 |
|:-----|:-----|:---------|
| MCU HAL 库 | Flash 操作 | 用户自行实现 |
| TinyCrypt | 加密算法 | 其他加密库 |

---

## 6. 开发工作流

### 6.1 代码开发流程

```
1. 在相应模块目录下创建/修改文件
2. 遵循命名规范和代码风格
3. 编写单元测试
4. 运行测试确保通过
5. 提交代码到版本控制
```

### 6.2 移植新平台流程

```
1. 在 smota/smota_hal/ports/ 下创建新平台目录
2. 实现 OTA_Hardware_Interface_t 接口
3. 修改链接脚本适配 Flash 布局
4. 配置 smota_config.h
5. 编译并测试
```

### 6.3 发布流程

```
1. 更新版本号
2. 运行完整测试套件
3. 生成固件包
4. 更新文档
5. 创建 Git Tag
6. 发布 Release
```

---

## 7. 用户集成指南

### 7.1 快速开始

**步骤 1：复制 smota 文件夹**

将 `smota/` 文件夹复制到你的项目：

```
YourProject/
├── src/
│   └── main.c
└── smota/                    # 复制整个 smota 文件夹
    ├── smota.h               # 统一头文件
    ├── smota_core/
    ├── smota_hal/
    ├── smota_crypto/
    └── ...
```

**步骤 2：配置编译器**

添加以下目录到头文件搜索路径：

| 目录 | 必须 | 说明 |
|:-----|:-----|:-----|
| `smota` | 是 | 包含 smota.h |
| `smota/smota_core/inc` | 是 | 核心头文件 |
| `smota/smota_hal/inc` | 是 | HAL 头文件 |
| `smota/smota_crypto/inc` | 条件 | 加密功能（如需） |

**步骤 3：添加源文件到编译**

```
# 必须添加的源文件
smota/smota_core/src/*.c

# 根据用户的平台，实现自己的prots接口
smota/smota_hal/ports/stm32g0b1/*.c      # STM32g0b1

# 根据配置添加
smota/smota_crypto/src/*.c           # 启用加密功能时
```

**步骤 4：在代码中使用**

```c
#include "smota.h"

int main(void) {
    // 初始化
    OTA_Init(&my_hal, work_buf, sizeof(work_buf));

    // 使用 OTA 功能...
}
```

### 7.2 目录结构说明

| 目录 | 用户需要复制 | 说明 |
|:-----|:------------|:-----|
| `smota/` | **是** | 代码父文件夹，整体复制 |
| `doc/` | 否 | 项目文档，可在线查看 |
| `smota_tools/` | 否 | 固件打包工具，PC端使用 |
| `examples/` | 否 | 示例代码，参考使用 |
| `tests/` | 否 | 测试代码 |

---

## 附录 A：Flash 地址映射

### 双 Bank 模式

```
0x08000000  ┌─────────────────┐
            │   Bootloader   │  8-16KB
0x08004000  ├─────────────────┤
            │   Bank 1       │  应用程序
            │   (Active)     │  (映射到 0x08000000)
0x08080000  ├─────────────────┤
            │   Bank 2       │  备份区
            │   (Inactive)   │  (下载区)
0x080C0000  └─────────────────┘
```

### 双槽位模式

```
0x08000000  ┌─────────────────┐
            │   Bootloader   │  8-16KB
0x08004000  ├─────────────────┤
            │   Slot 0       │  主应用区
            │   (Active)     │
0x08040000  ├─────────────────┤
            │   Slot 1       │  备份/下载区
            │   (Inactive)   │
0x08080000  └─────────────────┘
```

### 单分区模式

```
0x08000000  ┌─────────────────┐
            │   Bootloader   │  8-16KB
0x08004000  ├─────────────────┤
            │   App          │  应用程序
            │   (覆盖安装)   │  (无备份)
0x08080000  └─────────────────┘
```

---

**文档结束**
